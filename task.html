<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <!-- <meta name="viewport" content="user-scalable=no"> -->
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-external-html@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-slider-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-audio-response@1.0.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.2.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@1.2.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-video-button-response@1.2.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-browser-check@1.0.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />

    <script src="https://nyc3.digitaloceanspaces.com/experiments.childlanglab/childlanglabClient.js"></script>

    <script src="params.js"></script>
  </head>
  <body>
  </body>
  <script>

    var jsPsych = initJsPsych(
        {
            show_progress_bar: false,
            on_interaction_data_update: function(data) {
                console.log(JSON.stringify(data));
                jsPsych.data.get().addToLast({browser_event: data});
            },
            on_finish: function() {
                jsPsych.data.displayData();
            }
        }
    );


    var TRIAL_N = 1;
    var URL_CONDITION = jsPsych.data.getURLVariable('condition'); // get condition from url \
    var CONDITION = get_condition(URL_CONDITION);
    var RANDOM_LIST = `list${jsPsych.randomization.randomInt(1,2)}`; // get random list 
    var ALERT = "If you wish to participate, you must check the box next to the statement 'I agree to participate in this study.'"
    
    var consent = {
        type: jsPsychExternalHtml, 
        url: "consent.html", 
        cont_btn: "start", 
        check_fn: function(){
           if (document.getElementById('consent_checkbox').checked){
                return true
           } else {
                alert(ALERT);
                return false
           }
        }
    }; 

    var browser_check = {
        type: jsPsychBrowserCheck
    };

    function get_condition(condition){
        let conditions = ["AFC", "RATING", "SICR"];
        let random_condition = conditions[jsPsych.randomization.randomInt(0,2)]

        if (condition == 'random'){
            return random_condition
        } else {
            return condition
        }
    }
    var instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: function() {
            return `<div style="max-width: 800px; text-align: left">
            <p>Today we are going to watch some fun videos and play a game. In the videos, you are going to see Pingu, the little penguin, talking to her family
                and friends in the penguin language. Watch as Pingu goes about her day and listen carefully to the penguin language.</p>
            </div>`},
        prompt: "<p><strong>Click Continue to start watching the video.</strong></p>",
        choices: ["Continue"],
        button_html: function(){
            return [`<button class="jspsych-btn">%choice%</button>`]

        }
    };

    var thanks = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `<p><strong>The experiment is now finished.</strong></p>`,
        prompt: "Press Continue to see the data.",
        choices: ["Continue"],
        button_html: [`<button class="jspsych-btn">%choice%</button>`]
    };

    var sendData = {
        type: jsPsychCallFunction,
        async: true,
        func: function (done) {
            let data = jsPsych.data.get().json();
            childlanglabClient.sendData(data);
            done("Sent data object to childlanglab-api")
            
        },
    };

    var test_rating = {
        timeline: [{
            type: jsPsychAudioSliderResponse,
            stimulus: jsPsych.timelineVariable('sound1'),
            labels: ['Definitely Not a Word', 'Maybe a Word', 'Definitely a Word'],
            prompt: '<p>Is this a word in the language you just heard?</p>',
            response_allowed_while_playing: false,
            require_movement: true,
            post_trial_gap:2000
            
        }], 
        timeline_variables: PARAMS.conditions.RATING.test[RANDOM_LIST],
        repetitions: 1
    }

    var test_afc = {
        timeline: [
            {
                type: jsPsychAudioButtonResponse,
                stimulus: jsPsych.timelineVariable('sound1'),
                prompt: '<p>Which option sounds more like a word?</p>',
                response_allowed_while_playing: false,
                choices: ["1", "2"],
                trial_ends_after_audio: true, 
            }, 
            {
                type: jsPsychAudioButtonResponse,
                stimulus: jsPsych.timelineVariable('sound2'),
                prompt: '<p>Which option sounds more like a word?</p>',
                response_allowed_while_playing: false,
                choices: ["1", "2"],
                trial_ends_after_audio: false,
                post_trial_gap:2000,

            }
        ], 
        timeline_variables: PARAMS.conditions.AFC.test[RANDOM_LIST],
        repetitions: 1
    }; 

    var test_sicr = {
        timeline: [
            {
                type: jsPsychAudioKeyboardResponse,
                stimulus: jsPsych.timelineVariable('sound1'),
                prompt: '<p style="color: red;">Listen.</p>',
                response_allowed_while_playing: false,
                choices: "NO_KEYS",
                trial_ends_after_audio: true
            },
            {
                type: jsPsychAudioKeyboardResponse,
                stimulus: jsPsych.timelineVariable('sound2'),
                prompt: '<p style="color: red;">Listen.</p>',
                response_allowed_while_playing: false,
                choices: "NO_KEYS",
                trial_ends_after_audio: true
            },          
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: "",
                prompt: '<p style="color: black;">Repeat.</p>',
                choices: "NO_KEYS",          
                trial_duration: 3500,
                post_trial_gap:2000,

            }
        ], 
        timeline_variables: PARAMS.conditions.SICR.test[RANDOM_LIST],
        repetitions: 1
    };
    

    var exposure = {
        timeline: [
            { // take a break after each exposure set 
                type: jsPsychAudioKeyboardResponse,
                stimulus: jsPsych.timelineVariable('sound'),
                prompt: function() {
                return `<video id="pingu" width="100%" height="auto" autoplay muted>
                    <source src=${jsPsych.timelineVariable('video')} type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <p>Listen carefully. Press space whenever you hear a beep.</p>`
                },
                choices: " ",
                response_ends_trial: false,
                trial_ends_after_audio: true,
                post_trial_gap: 1000,
            }, 
            { // take a break after each exposure set 
                type: jsPsychHtmlButtonResponse,
                stimulus: function(){
                    return `<img src=images/pingu-still-wave.png width=600px></img><p style="font-family: monospace"><strong>Great Job! Take a break!</strong></p>`
                    return `<p style="font-family: monospace"><strong>Great Job! Take a break!</strong></p>`

                },
                prompt: "Press Continue when you are ready to keep going",
                choices: ["Continue"],
                button_html: [`<button class="jspsych-btn">%choice%</button>`],
                post_trial_gap: 1000,

            }
        ],
        timeline_variables: [
            {sound: 'sounds/exposure_1min30sec.wav', video: 'video/Pingu_Block1.mp4'},
            {sound: 'sounds/exposure_1min30sec.wav', video: 'video/Pingu_Block2.mp4'},
            {sound: 'sounds/exposure_1min30sec.wav', video: 'video/Pingu_Block3.mp4'}
        ],
        repetitions: 1,     
        randomize_order: false
    }

    var preload = {
        type: jsPsychPreload,
        audio: PARAMS.preload.audio,
        images: PARAMS.preload.images,
        videos: PARAMS.preload.videos,
        show_detailed_errors: true
    }

    var get_test = function(condition) {

        switch (condition) {
            case 'AFC':
                return test_afc
            case 'RATING':
                return test_rating
            case 'SICR':
                return test_sicr
            default:
                break;
        }
    }

    var timeline = [
        consent,
        browser_check,
        preload,
        instructions, 
        exposure,
        get_test(CONDITION),
        thanks
    ]

    jsPsych.run(timeline);


  </script>
</html>