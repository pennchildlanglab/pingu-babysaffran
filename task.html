<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <!-- <meta name="viewport" content="user-scalable=no"> -->
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-external-html@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-slider-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-audio-response@1.0.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.2.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@1.2.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-video-button-response@1.2.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-browser-check@1.0.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />

    <script src="https://nyc3.digitaloceanspaces.com/experiments.childlanglab/childlanglabClient.js"></script>

    <script src="params.js"></script>
  </head>
  <body>
  </body>
  <script>

    var jsPsych = initJsPsych(
        {
            show_progress_bar: false,
            on_interaction_data_update: function(data) {
                console.log(JSON.stringify(data));
                jsPsych.data.get().addToLast({browser_event: data});
            },
            on_finish: function() {
                jsPsych.data.displayData();
            }
        }
    );


    var TRIAL_N = 1;
    var URL_CONDITION = jsPsych.data.getURLVariable('condition'); // get condition from url \
    var CONDITION = get_condition(URL_CONDITION);
    var CONDITION_PARAMS = get_params(CONDITION); 
    var RANDOM_LIST = `list${jsPsych.randomization.randomInt(1,2)}`; // get random list 
    var ALERT = "If you wish to participate, you must check the box next to the statement 'I agree to participate in this study.'"
    
    var consent = {
        type: jsPsychExternalHtml, 
        url: "consent.html", 
        cont_btn: "start", 
        check_fn: function(){
           if (document.getElementById('consent_checkbox').checked){
                return true
           } else {
                alert(ALERT);
                return false
           }
        }
    }; 

    var browser_check = {
        type: jsPsychBrowserCheck
    };

    function get_condition(condition){
        let conditions = ["AFC", "RATING", "SICR"];
        let random_condition = conditions[jsPsych.randomization.randomInt(0,2)]

        if (condition == 'random'){
            return random_condition
        } else {
            return condition
        }
    };

    function get_params(condition){
        console.log(PARAMS.conditions)
        console.log(PARAMS.conditions[condition])
        return PARAMS.conditions[condition]; 

    }

    var get_instructions = function(these_instructions) {
        console.log(these_instructions)
        var instructions = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                return `<div style="max-width: 800px; text-align: left"><p>${these_instructions}</p></div>`},
            prompt: "<p></p>",
            choices: ["Continue"],
            button_html: function(){
                return [`<button class="jspsych-btn" style="background-color: lightgreen">%choice%</button>`]
            }
        }

        return instructions
        
    }; 

    var thanks = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `<p><strong>The experiment is now finished.</strong></p>`,
        prompt: "Press Continue to see the data.",
        choices: ["Continue"],
        button_html: [`<button class="jspsych-btn">%choice%</button>`]
    };

    var sendData = {
        type: jsPsychCallFunction,
        async: true,
        func: function (done) {
            let data = jsPsych.data.get().json();
            childlanglabClient.sendData(data);
            done("Sent data object to childlanglab-api")
            
        },
    };

    var fixation = {
        type: jsPsychHtmlKeyboardResponse, 
        stimulus: "+", 
        choices: "NO_KEYS", 
        response_ends_trial: false, 
        trial_duration: 1000
    };

    var test_rating = {
        timeline: [
        {
                type: jsPsychAudioSliderResponse,
                stimulus: "sounds/silence.wav",
                labels: ['Not at all like a penguin word', 'Definitely a penguin word'],
                on_load: function(){
                    let display_element = document.querySelector('#jspsych-content');
                    let image = document.createElement('img');
                    image.src = "images/pingu-wait.png";  // Replace with your actual image URL
                    image.style.width = '450px';
                    display_element.prepend(image);
                },
                response_ends_trial: false,
                response_allowed_while_playing: false,
                trial_duration: 1000

            }, 
            {
                type: jsPsychAudioSliderResponse,
                stimulus: jsPsych.timelineVariable('sound1'),
                labels: ['Not at all like a penguin word', 'Definitely a penguin word'],
                on_load: function(){
                    let display_element = document.querySelector('#jspsych-content');
                    let image = document.createElement('img');
                    image.src = "images/pingu-option-blue.png";  // Replace with your actual image URL
                    image.style.width = '450px';
                    display_element.prepend(image);
                },
                response_allowed_while_playing: false,
                require_movement: true
            }
        ], 
        timeline_variables: PARAMS.conditions.RATING.test[RANDOM_LIST],
        repetitions: 1
    }

    var test_afc = {
        timeline: [
            {
                type: jsPsychHtmlButtonResponse,
                stimulus: "",
                prompt: '<p>Which option sounds more like a word in the penguin language?</p>',
                response_allowed_while_playing: false,
                choices: ["images/pingu-wait.png", "images/pingu-wait.png"],
                button_html: [
                    `<button class="jspsych-btn" style="opacity: 0.2"> <img src=%choice% width="600"></button>`, 
                    `<button class="jspsych-btn" style="opacity: 0.2"> <img src=%choice% width="600"></button>`
                ], 
                trial_duration: 1000,
                trial_ends_after_audio: true,
            }, 
            {
                type: jsPsychAudioButtonResponse,
                stimulus: jsPsych.timelineVariable('sound1'),
                prompt: '<p>Which option sounds more like a word in the penguin language?</p>',
                response_allowed_while_playing: false,
                choices: ["images/pingu-option-blue.png", "images/pingu-wait.png"],
                button_html: [
                    `<button class="jspsych-btn"> <img src=%choice% width="600"></button>`, 
                    `<button class="jspsych-btn" style="opacity: 0.2"> <img src=%choice% width="600"></button>`
                ], 
                trial_ends_after_audio: true, 
            }, 
            {
                type: jsPsychAudioButtonResponse,
                stimulus: jsPsych.timelineVariable('sound2'),
                prompt: '<p>Which option sounds more like a word in the penguin language?</p>',
                response_allowed_while_playing: false,
                choices: ["images/pingu-option-blue.png", "images/pingu-option-purple.png"],
                button_html: [
                    `<button class="jspsych-btn" style="opacity: 0.2"> <img src=%choice% width="600"></button>`, 
                    `<button class="jspsych-btn"> <img src=%choice% width="600"></button>`
                ], 
                trial_ends_after_audio: true

            }, 
            {
                type: jsPsychHtmlButtonResponse,
                stimulus: "",
                prompt: '<p>Which option sounds more like a word in the penguin language?</p>',
                choices: ["images/pingu-option-blue.png", "images/pingu-option-purple.png"],
                button_html: [
                    `<button class="jspsych-btn" > <img src=%choice% width="600"></button>`, 
                    `<button class="jspsych-btn" > <img src=%choice% width="600"></button>`
                ], 
                response_ends_trial: true
            }, 

            fixation
        ], 
        timeline_variables: PARAMS.conditions.AFC.test[RANDOM_LIST],
        repetitions: 1
    }; 

    var test_sicr = {
        timeline: [
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: "",
                prompt: '<img src="images/pingu-wait.png" width="600">',
                choices: "NO_KEYS",          
                trial_duration: 1000, 
                post_trial_gap: 0
            },
            {
                type: jsPsychAudioKeyboardResponse,
                stimulus: jsPsych.timelineVariable('sound1'),
                prompt: '<img src="images/pingu-option-blue.png" width="600">',
                response_allowed_while_playing: false,
                choices: "NO_KEYS",
                trial_ends_after_audio: true, 
                post_trial_gap: 0
            },
            {
                type: jsPsychAudioKeyboardResponse,
                stimulus: jsPsych.timelineVariable('sound2'),
                prompt: '<img src="images/pingu-option-blue.png" width="600">',
                response_allowed_while_playing: false,
                choices: "NO_KEYS",
                trial_ends_after_audio: true, 
                post_trial_gap: 0
            },          
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: "",
                prompt: '<img src="images/pingu-listens.png" width="600">',
                choices: "NO_KEYS",          
                trial_duration: 3500, 
                post_trial_gap: 0
            },
            fixation
        ], 
        timeline_variables: PARAMS.conditions.SICR.test[RANDOM_LIST],
        repetitions: 1
    };
    

    var exposure = {
        timeline: [
            { // take a break after each exposure set 
                type: jsPsychAudioKeyboardResponse,
                stimulus: jsPsych.timelineVariable('sound'),
                prompt: function() {
                return `<video id="pingu" width="100%" height="auto" autoplay muted>
                    <source src=${jsPsych.timelineVariable('video')} type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <p></p>`
                },
                choices: " ",
                response_ends_trial: false,
                trial_ends_after_audio: true,
                post_trial_gap: 1000,
            }, 
            { // take a break after each exposure set 
                type: jsPsychHtmlButtonResponse,
                stimulus: "",
                prompt: "What was pingu doing in the video you watched?",
                choices: function() {
                    let choices = [jsPsych.timelineVariable('correct'), jsPsych.timelineVariable('foil')]; 
                    let shuffled_choices = jsPsych.randomization.shuffle(choices); 
                    return shuffled_choices; 
                }, 
                button_html: [
                    `<button class="jspsych-btn"> <img src=%choice% width="400"></button>`, 
                    `<button class="jspsych-btn"> <img src=%choice% width="400"></button>`
                ], 
                post_trial_gap: 1000,

            }
        ],
        timeline_variables: [
            {sound: 'sounds/block-1-stim.mp3', video: 'video/Pingu_Block1.mp4', correct: "images/block-1-comp-c.png", foil: "images/block-1-comp-f.png"},
            {sound: 'sounds/block-2-stim.mp3', video: 'video/Pingu_Block2.mp4', correct: "images/block-2-comp-c.png", foil: "images/block-2-comp-f.png"},
            {sound: 'sounds/block-3-stim.mp3', video: 'video/Pingu_Block3.mp4', correct: "images/block-3-comp-c.png", foil: "images/block-3-comp-f.png"}
        ],
        repetitions: 1,     
        randomize_order: false
    }

    var exit_survey = {
        type: jsPsychHtmlSliderResponse,
        prompt: `
            <p>Please answer honestly. Your compensation will NOT be affected by your answer.</p>`,
        stimulus: `
            <h3>Exit survey</h3>
            <p>How engaged were you in the task?</p>`,
        require_movement: true,
        labels: ['I was very distracted', 'I paid close attention the whole time']
    };

    var preload = {
        type: jsPsychPreload,
        audio: PARAMS.preload.audio,
        images: PARAMS.preload.images,
        videos: PARAMS.preload.videos,
        show_detailed_errors: true
    }

    var get_test = function(condition) {

        switch (condition) {
            case 'AFC':
                return test_afc
            case 'RATING':
                return test_rating
            case 'SICR':
                return test_sicr
            default:
                break;
        }
    }

    var timeline = [
       // consent,
       // browser_check,
        preload,
        get_instructions(CONDITION_PARAMS.instructions.exposure), 
        exposure,
        get_instructions(CONDITION_PARAMS.instructions.practice),
        get_test(CONDITION),
        get_instructions(CONDITION_PARAMS.instructions.test),
        get_test(CONDITION),
        exit_survey,
        thanks
    ]

    jsPsych.run(timeline);


  </script>
</html>
